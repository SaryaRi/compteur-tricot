<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compteur Tricot</title>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  margin: 0;
  padding: 20px;
  background-color: #f3e8ff;
  color: #4b2e83;
}

#container {
  max-width: 400px;
  margin: auto;
}

h1, h2, h3 {
  color: #6a4fbf;
}

button {
  width: 100%;
  padding: 12px;
  font-size: 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background-color: #d7c4ff;
  color: #4b2e83;
  margin: 6px 0;
}

button:hover {
  background-color: #c9b2ff;
}

#reset {
  background-color: #b388ff;
  color: white;
}

#reset:hover {
  background-color: #9f6fff;
}

#history {
  margin-top: 15px;
  text-align: left;
  font-size: 14px;
  max-height: 300px;
  overflow-y: auto;
}

.history-entry {
  background: #e9d8ff;
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<div id="container">

  <h2 id="projectName">Chargement…</h2>
  <button onclick="editProjectName()">Modifier le nom</button>

  <a id="projectLink" href="#" target="_blank">Lien du projet</a>
  <button onclick="editProjectLink()">Modifier le lien</button>

  <h1 id="count">0</h1>

  <button onclick="updateCount(1)">+1</button>
  <button onclick="updateCount(-1)">-1</button>
  <button id="reset" onclick="resetCount()">Reset</button>

  <h3>Historique</h3>
  <div id="history"></div>

</div>

<script>
const repoOwner = "SaryaRi";
const repoName = "compteur-tricot";
const filePath = "data.json";
const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
let fileSha = null;
let token = null;

// Charger les données JSON
async function loadData() {
  const response = await fetch(`https://${repoOwner}.github.io/${repoName}/data.json`);
  const data = await response.json();

  document.getElementById("projectName").textContent = data.projectName;
  document.getElementById("projectLink").textContent = data.projectLink || "Aucun lien";
  document.getElementById("projectLink").href = data.projectLink || "#";
  document.getElementById("count").textContent = data.count;

  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML = "";
  data.history.slice().reverse().forEach(entry => {
    const div = document.createElement("div");
    div.className = "history-entry";
    div.textContent = entry;
    historyDiv.appendChild(div);
  });

  return data;
}

// Mise à jour GitHub
async function saveData(newData) {
  if (!token) {
    token = prompt("Entre ton token GitHub (il sera gardé en mémoire locale)");
    localStorage.setItem("githubToken", token);
  }

  const content = btoa(JSON.stringify(newData, null, 2));

  const getFile = await fetch(apiUrl);
  const fileInfo = await getFile.json();
  fileSha = fileInfo.sha;

  await fetch(apiUrl, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update data.json",
      content: content,
      sha: fileSha
    })
  });

  loadData();
}

// Actions
async function updateCount(delta) {
  const data = await loadData();
  data.count += delta;

  const now = new Date();
  data.history.push(`${delta > 0 ? "+1" : "-1"} le ${now.toLocaleDateString()} à ${now.toLocaleTimeString()}`);

  saveData(data);
}

async function resetCount() {
  const data = await loadData();
  data.count = 0;

  const now = new Date();
  data.history.push(`Reset le ${now.toLocaleDateString()} à ${now.toLocaleTimeString()}`);

  saveData(data);
}

async function editProjectName() {
  const data = await loadData();
  const newName = prompt("Nom du projet :", data.projectName);
  if (newName) {
    data.projectName = newName;
    saveData(data);
  }
}

async function editProjectLink() {
  const data = await loadData();
  const newLink = prompt("Lien du projet :", data.projectLink);
  if (newLink) {
    data.projectLink = newLink;
    saveData(data);
  }
}

// Charger token si déjà enregistré
token = localStorage.getItem("githubToken");

// Charger les données au démarrage
loadData();
</script>

</body>
</html>
